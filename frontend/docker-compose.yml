# ================================================
# üöÄ MoreTech.VTB Frontend - Docker Compose
# ================================================
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –ø—Ä–æ–¥–∞–∫—à–Ω
# –í–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ backend —Å–µ—Ä–≤–∏—Å–∞–º
# ================================================

version: '3.8'

services:
  # ================================================
  # üé® Frontend - React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
  # ================================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: moretech-frontend
    ports:
      - "3000:80"
    environment:
      - NODE_ENV=production
      # –ü—Ä–æ–∫–∏–Ω–µ–º Vite env –¥–ª—è prod, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –¥–∏–Ω–∞–º–∏–∫–∞
      - VITE_API_URL=/api
      - VITE_WS_TRANSCRIPTION_URL=/ws/voice
      - VITE_WS_TTS_URL=/ws/speak
    volumes:
      # –õ–æ–≥–∏ Nginx –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      - ./logs:/var/log/nginx
    networks:
      - moretech-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`localhost`)"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"

  # ================================================
  # üîß Development –≤–µ—Ä—Å–∏—è (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
  # ================================================
  frontend-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    container_name: moretech-frontend-dev
    ports:
      - "3001:3000"
    environment:
      - NODE_ENV=development
      # –î–ª—è Linux –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–¥—Ä–µ—Å —Ö–æ—Å—Ç–∞, –¥–æ—Å—Ç—É–ø–Ω—ã–π –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:
      - VITE_API_URL=http://host.docker.internal:5000
      - VITE_WS_TRANSCRIPTION_URL=ws://host.docker.internal:8001/ws/voice
      - VITE_WS_TTS_URL=ws://host.docker.internal:8003/ws/speak
    volumes:
      # –î–ª—è hot reload –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
      - .:/app
      - /app/node_modules
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - moretech-network
    command: npm run dev
    profiles:
      - dev
    restart: unless-stopped

# ================================================
# üåê –°–µ—Ç—å –¥–ª—è —Å–≤—è–∑–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
# ================================================
networks:
  moretech-network:
    driver: bridge
    name: moretech-network

# ================================================
# üíæ –¢–æ–º–∞ –¥–ª—è –ª–æ–≥–æ–≤
# ================================================
volumes:
  frontend-logs:
    driver: local
